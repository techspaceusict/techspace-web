{% extends '../community/base.html' %}

{% block content %}

<div style="position:absolute; width:100%; background-image:url('https://lh4.googleusercontent.com/j9Rz1sytr6GO_4mfb-p5kGwXBtD9mXB54M3nCF-B3twVHpnUXCBwdwovD6M4YyHYT2FVSEKUFbVr7baIPSgeO65Fn6cpNu-jAUCAvf2Dfc4VTWKWADMXNxU0Z_4p-Zwg_w3F1E__nR-Molg'); width:100%; height:250px; background-size:cover; z-index:0;">
<!--<img src="https://lh4.googleusercontent.com/j9Rz1sytr6GO_4mfb-p5kGwXBtD9mXB54M3nCF-B3twVHpnUXCBwdwovD6M4YyHYT2FVSEKUFbVr7baIPSgeO65Fn6cpNu-jAUCAvf2Dfc4VTWKWADMXNxU0Z_4p-Zwg_w3F1E__nR-Molg" style="width:100%; height:250px;">-->
</div>
	<div class="container" style="margin-top:150px; background-color:#ffffff; z-index:1; position:relative;">

	{% if blog_detail %}

<div class="blog_content center">
  <br>
 <div class="center">
   <div style="text-align: center;" >
  		<h1 style="font-size:30px;">{{ blog_detail.title }}</h1>
  		<h4 style="color: #f29260">By: <a href="{% url 'log:dashboard' name=blog_detail.author %}">{{ blog_detail.author }}</a></h4>
  		<h5 style="color:#3d3d29"> {{ blog_detail.date }} </h4>
  		<div class="underline"></div>
    </div>
		{% if blog_detail.image.url is not None %}
		<div class="container-fluid card">
		<img class="centre img-responsive blog_image" src="{{ blog_detail.image.url }}">
		{% else %}
		<h5>image not found</h5>
	</div>
		{% endif %}
		<div class="blog-detail-content">

		 {{ blog_detail.content|safe|linebreaks }}

	 	</div>
    {% if user.username == blog_detail.author %}

    		<div class="stack" style="text-align: center;">
    			<form style="display: inline;" action="{% url 'blog:blog-edit' blog_detail.slug %}" method="get" class="form-group">
    				<button class="btn btn-primary">Edit</button>
    			</form>
    			<form style="display: inline; margin-left: 20px;" action="{% url 'blog:blog-delete' blog_detail.slug %}" method="post" class="form-group">
    				{% csrf_token %}
    				<button class="btn btn-danger">Delete</button>
    			</form>
    		</div>
    	{% endif %}


		<!-- upvotes and comments -->

<hr>

	 	<div class="post-actions">
				{% if user.is_authenticated %}
					<!-- <form class="form-horizontal" action="{% url 'community:toggle-upvote'%}" method="post">
							<input type="hidden" value="{{ blog_detail.title }}" name="title">
							<input type="hidden" value="1" name="onDetailPage">
							{% csrf_token %}
							<input type="hidden" value="{{ blog_detail.state }}" name="state">
									{% if blog_detail.state == 1 %}
											<button type="submit" class="post-actions-button small-p upvoted"><i class="fa fa-thumbs-up"></i> Upvoted({{ blog_detail.upvotes }})</button> |
									{% endif %}
									{% if blog_detail.state == 0 %}
											<button type="submit" class="post-actions-button small-p"><i class="fa fa-thumbs-up"></i> Upvote ({{ blog_detail.upvotes }})</button> |
									{% endif %}
					</form> -->

					<form class="form-horizontal upvote-form" id="{{ blog_detail.id }}" action="{% url 'community:toggle-upvote'%}" method="post">
							<input type="hidden" value="{{ blog_detail.id }}" name="id">
							{% csrf_token %}
							<input type="hidden" id="state-{{blog_detail.id}}" value="{{ blog_detail.state }}" name="state">
							<button type="submit" id="btn-{{ blog_detail.id }}" class="post-actions-button small-p {%if blog_detail.state == 1%}upvoted{%else%}{%endif%}"><i class="fa fa-thumbs-up"></i> ({{ blog_detail.upvotes }})</button> |
					</form>
					<hr>
				{% endif %}
				<p style="margin-top:-20px;">{{ blog_detail.comments.all.count }} comment{{blog_detail.comments.all.count|pluralize}}</p>
		</div>
{% if user.is_authenticated %}
		<div class="container">
			<form class="form-horizontal form-group comment-form" method="post" enctype="multipart/form-data" >
        <div class="container">
				{% csrf_token %}
        {% include '../global_components/form-template.html' %}
				<div class="list-group mention_suggestions"></div>
          <div class="col-sm-offset-2">
            <button class="btn-wire-dark">Submit</button>
          </div>
			  </div>
			</form>
		</div>

{% else %}
<h3>What are your thoughts. <a href="{% url 'login' %}">Log in</a> or <a href="{% url 'register' %}">Sign up</a></h3>

{% endif %}

<!-- displaying all comments -->

<div class="container">
<ul class="list-group comment-list">
	{% for comment in comments reversed %}
	<div class="comment list-group-item">
		<div class="comment-user-img">
			<img src="{{ comment.author.profile_pic.url }}" />
		</div>
		<div class="comment-block">
			<a href="{% url 'log:dashboard' name=comment.comment_author %}"> {{ comment.comment_author }}</a>
			<span class="blog-date"><strong style="color:#000;font-size:20px;"></strong>   {{ comment.comment_date }}</span>
			<br>
			<h6>{{ comment.comment_text|safe }}</h6>
		</div>
		<ul class="list-group comment-reply-list-{{ comment.id }}">
				{% for reply in comment.reply_comments %}
				<li class="list-group-item " style="text-align:left;"><h6>{{ reply.comment_text|safe|linebreaks }}</h6><p> <span class="blog-date"><strong style="color:#000;font-size:15px;">  By:<a href="{% url 'log:dashboard' name=comment.comment_author %}">{{ reply.comment_author }}</a></strong>   {{ reply.comment_date }}</span></p>
				{% if user.is_authenticated %}
				<form class="form-horizontal comment-upvote-form" id="{{ reply.id }}" action="{% url 'blog:toggle-comment-upvote'%}" method="post">
						<input type="hidden" value="{{ reply.id }}" name="id">
						{% csrf_token %}
						<input type="hidden" id="state-comment-{{reply.id}}" value="{{ reply.state }}" name="state">
						<button type="submit" id="btn-comment-{{ reply.id }}" class="post-actions-button small-p {%if reply.state == 1%}upvoted{%else%}{%endif%}"><i class="fa fa-thumbs-up"></i> ({{ reply.upvotes_len }})</button> |
				</form>
				{% endif %}
				</li>
				{% endfor %}
		</ul>
		{% if user.is_authenticated %}
		<form class="form-horizontal comment-upvote-form" id="{{ comment.id }}" action="{% url 'blog:toggle-comment-upvote'%}" method="post">
				<input type="hidden" value="{{ comment.id }}" name="id">
				{% csrf_token %}
				<input type="hidden" id="state-comment-{{comment.id}}" value="{{ comment.state }}" name="state">
				<button type="submit" id="btn-comment-{{ comment.id }}" class="post-actions-button small-p {%if comment.state == 1%}upvoted{%else%}{%endif%}"><i class="fa fa-thumbs-up"></i> ({{ comment.upvotes_len }})</button> |
		</form>
		<a class="reply-btn btn" onclick="showReplyForm({{comment.id}});">Reply</a>
		<form class="form-horizontal comment-reply-form comment-reply-form-{{comment.id}}" id="{{ comment.id }}" action="{% url 'blog:reply-comment' %}" method="post">
			{% csrf_token %}
			<input class="{{ comment.id }}" id="input-{{ comment.id }}" name="comment_text" autocomplete="off" required type="text" oninput="get_suggestions(this.value, this.className);" />
			<input type="hidden" value="{{ comment.id }}" name="id" />
			<button class="comment-reply-btn" type="submit" style="display: inline-block;">Reply</button>
			<div class="list-group mention_suggestions-{{ comment.id }}"></div>
			<!-- {{ form.comment_text }} -->
		</form>
		{% endif %}
	</div>
	{% endfor %}

</ul>
</div>

<!--

<h4>No comments yet</h4> -->
</div>











	{% else %}
		<h1>How come you came here if there is no blog!!! kindly tell <a href="mailto:prafful.usict.025164@ipu.ac.in?subject=feedback">me</a></h1>

	{% endif %}
</div>



{% endblock %}

{% block scripts %}
<script type="text/javascript">

	function showReplyForm(id) {
		var form = document.getElementsByClassName("comment-reply-form-" + id)[0];
		if (form.style.display == "inline"){
			form.style.display = "none";
		}
		else {
			form.style.display = "inline";
		}
	}

	//For Comments
	$(document).on('submit', '.comment-form', function(e) {
		e.preventDefault();
		e.stopPropagation();
		var $form = $(this);
		var url = window.location.href;
		$.post(url, $form.serialize())
			.done(function(data) {
				addComment(data);
				$form[0].reset();
				$(".mention_suggestions").empty();
			});
	});

	function addComment(data){
		var csrf = $("input[name='csrfmiddlewaretoken']").first().val();
		var new_comment = '<li class="list-group-item " style="background-color: #f7f7f7;text-align:left"><h6><p>' + data.text + '</p></h6><p> <span class="blog-date"><strong style="color:#000;font-size:20px;"> By:' + data.author + '</strong>   ' + data.date + '</span></p><ul class="list-group comment-reply-list-' + data.id + '"></ul><form class="form-horizontal comment-upvote-form" id="' + data.id + '" action="/post/togglecommentupvote" method="post"><input type="hidden" name="csrfmiddlewaretoken" value="'+ csrf + '"><input type="hidden" value="' + data.id + '" name="id"><input type="hidden" id="state-comment-' + data.id + '" value="0" name="state"><button type="submit" id="btn-comment-' + data.id + '" class="post-actions-button small-p"><i class="fa fa-thumbs-up"></i> (0)</button> |</form><form class="form-horizontal comment-reply-form" id="' + data.id + '" action="/post/reply_comment" method="post"><input type="hidden" name="csrfmiddlewaretoken" value="'+csrf+'"><input type="text" name="comment_text" placeholder="What are your thoughts..." required="" id="id_comment_text"><input type="hidden" value="' + data.id + '" name="id"><button type="submit" style="display: inline-block;">Reply</button></form></li>';

		$(".comment-list").prepend(new_comment);
	}

	//For comment reply
	$(document).on('submit', '.comment-reply-form', function(e) {
		e.preventDefault();
		e.stopPropagation();
		var $form = $(this);
		var url = $form.attr("action");
		$.post(url, $form.serialize())
			.done(function(data) {
				addCommentReply(data);
				$form[0].reset();
			});
	});

	function addCommentReply(data){
		var csrf = $("input[name='csrfmiddlewaretoken']").first().val();
		var new_reply = '<li class="list-group-item" style="text-align:left;"><h6>' + data.text + '</h6><p> <span class="blog-date"><strong style="color:#000;font-size:15px;"> By:' + data.author + '</strong>   ' + data.date + '</span></p><form class="form-horizontal comment-upvote-form" id="' + data.id + '" action="/post/togglecommentupvote" method="post"><input type="hidden" value="' + data.id + '" name="id"><input type="hidden" name="csrfmiddlewaretoken" value="' + csrf + '"><input type="hidden" id="state-comment-' + data.id + '" value="0" name="state"><button type="submit" id="btn-comment-' + data.id + '" class="post-actions-button small-p"><i class="fa fa-thumbs-up"></i> (0)</button> |</form></li>';
		$(".comment-reply-list-"+data.parent_id).append(new_reply);
	}


	// For Blog Upvotes
  $(document).on('submit', '.upvote-form',function(e) {
      e.preventDefault();
      e.stopPropagation();
      var $form = $(this);
      var url = $form.attr( "action" );
      var thisId = $form.attr( "id" );
      $.post(url, $form.serialize())
          .done(function(data) {
              changeButton(data, thisId);
          });
  });

    function changeButton(data, id){
      if(data.state){
        $("#btn-"+id).addClass("upvoted");
      }
      else {
        $("#btn-"+id).removeClass("upvoted");
      }
      $("#state-"+id).val(data.state ? 1 : 0);
      $("#btn-"+id).html('<i class="fa fa-thumbs-up"></i> ('+data.upvotes+')');
    }

		// For Comment Upvotes
		$(document).on('submit', '.comment-upvote-form',function(e) {
	      e.preventDefault();
	      e.stopPropagation();
	      var $form = $(this);
	      var url = $form.attr( "action" );
	      var thisId = $form.attr( "id" );
	      $.post(url, $form.serialize())
	          .done(function(data) {
	              changeCommentUpvoteButton(data, thisId);
	          });
	  });

	    function changeCommentUpvoteButton(data, id){
	      if(data.state){
	        $("#btn-comment-"+id).addClass("upvoted");
	      }
	      else {
	        $("#btn-comment-"+id).removeClass("upvoted");
	      }
	      $("#state-comment-"+id).val(data.state ? 1 : 0);
	      $("#btn-comment-"+id).html('<i class="fa fa-thumbs-up"></i> ('+data.upvotes+')');
	    }

			function single_suggestion(item, index){
				var div = '<div class="list-group-item" onClick="fill_comment(this.innerHTML);">' + item + '</div>';
				return div;
			}

			function single_suggestion_reply(item, id){
				var div = '<div class="list-group-item" id="' + id + '" onClick="fill_comment(this.innerHTML, this.id);">' + item + '</div>';
				return div;
			}

			function input_autocomplete(data, id){
				var obj = JSON.parse(data);
				if(id == null){
					$(".mention_suggestions").empty().html(Object.values(obj).map(single_suggestion));
				}
				else {
					$(".mention_suggestions-" + id).empty().html(Object.values(obj).map(
						function(s) { return single_suggestion_reply(s, id) }
					));
				}
			}

			var save = false;
			var text = "";
			var index = -1;
			function get_suggestions(val, id=null){
				if(save){
					text += val.substr(val.length - 1);
					var domain = window.location.hostname;
					$.get("http://" + domain + ":8000/post/mention_suggestion", {'text': text})
						.done(function(data){
							input_autocomplete(data, id);
						});
				}
				if(val.substr(val.length - 1) == '@'){
					save = true;
					index = val.length - 1;
				}
				if(val.substr(val.length - 1) == ' '){
					save = false;
					text = "";
					index = -1;
				}
			}

			function fill_comment(str, id=null){
				if(id == null){
					var input = document.getElementById("id_comment_text");
				}
				else {
					var input = document.getElementById("input-"+id);
				}
				var cur_val = input.value
				var val = cur_val.substr(0, index + 1);
				input.value = val + str;
			}




</script>

{% endblock %}
